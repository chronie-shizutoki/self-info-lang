<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Info - Language Choose</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div>
        <h1>Self Info - Language Choose</h1>
        <!-- Language-specific text containers -->
        <div id="language-text" class="language-text">
            <p class="lang-en">If this is not your preferred language, please select your desired language from the top-right</p>
            <p class="lang-ja">これがあなたの希望する言語でない場合は、右上から希望の言語を選択してください</p>
            <p class="lang-zh-CN">如果这不是你希望的语言，请从右上角选择你希望的语言</p>
            <p class="lang-zh-MY">如果这不是你希望的语言，请从右上角选择你希望的语言</p>
            <p class="lang-zh-SG">如果这不是你希望的语言，请从右上角选择你希望的语言</p>
            <p class="lang-zh-TW">如果這不是你希望的語言，請從右上角選擇你希望的語言</p>
        </div>
        
        <!-- This will be populated by the script with language recommendations -->
        <div id="language-recommendation" class="language-recommendation">
            <h3 class="lang-en">Recommended Language:</h3>
            <h3 class="lang-ja hidden">推奨される言語：</h3>
            <h3 class="lang-zh-CN hidden">推荐语言：</h3>
            <h3 class="lang-zh-MY hidden">推荐语言：</h3>
            <h3 class="lang-zh-SG hidden">推荐语言：</h3>
            <h3 class="lang-zh-TW hidden">推薦語言：</h3>
            <div id="recommended-langs"></div>
        </div>
    
    <!-- 样式已移至index.css文件中 -->
    
    <!-- Feedback button with language-specific text -->
    <button id="feedback-button" class="feedback-button">
        <i class="fas fa-comment-dots"></i>
        <span class="feedback-text lang-en">Feedback</span>
        <span class="feedback-text lang-ja hidden">フィードバック</span>
        <span class="feedback-text lang-zh-CN hidden">反馈</span>
        <span class="feedback-text lang-zh-TW hidden">回饋</span>
    </button>
    
    <script>
        // Add event listener to feedback button
        document.getElementById('feedback-button').addEventListener('click', function() {
            window.open('https://jyskyp4y.forms.app/untitled-form', '_blank');
        });
        
        // Function to update feedback button text based on current language
        function updateFeedbackButton(languageCode) {
            // Hide all language-specific text
            document.querySelectorAll('.feedback-text').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show text for the detected language
            const langElement = document.querySelector(`.feedback-text.lang-${languageCode}`);
            if (langElement) {
                langElement.classList.add('active');
            } else {
                // Fallback to English if the language code isn't found
                document.querySelector('.feedback-text.lang-en').classList.add('active');
            }
        }
    </script>
    
    <script src="lang.js"></script>
    <!-- Global debug function for switching language via console -->
    <script>
        // Make this function available in global scope
        function switchLanguage(languageCode) {
            // Language data with names and external links
            const languages = [
                { code: 'en', name: 'English', localName: 'English', link: 'https://chronie-shizutoki.github.io/self-info-en' },
                { code: 'ja', name: '日本語', localName: 'Japanese', link: 'https://self-info-ja.netlify.app/' },
                { code: 'zh-CN', name: '简体中文（中国大陆）', localName: 'Simplified Chinese (China)', link: 'https://chronie-shizutoki-self-info-zh-cn.netlify.app/' },
                { code: 'zh-MY', name: '华文（马来西亚）', localName: 'Chinese (Malaysia)', link: 'https://chronie-shizutoki.github.io/self-info-zh-my/' },
                { code: 'zh-SG', name: '华文（新加坡）', localName: 'Chinese (Singapore)', link: 'https://chronie-shizutoki.github.io/self-info-zh-sg/' },
                { code: 'zh-TW', name: '繁體中文（台灣）', localName: 'Traditional Chinese (Taiwan)', link: 'https://chronie-shizutoki.github.io/self-info-zh-tw/' },
            ];
            
            // Show only the text for the specified language
            function showLanguageText(languageCode) {
                // Hide all language-specific text
                document.querySelectorAll('.language-text p').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Hide all language-specific headings
                document.querySelectorAll('#language-recommendation h3').forEach(el => {
                    el.classList.add('hidden');
                });
                
                // Show text for the detected language
                const langElement = document.querySelector(`.lang-${languageCode}`);
                if (langElement) {
                    document.querySelectorAll(`.lang-${languageCode}`).forEach(el => {
                        el.classList.add('active');
                    });
                } else {
                    // Fallback to English if the language code isn't found
                    document.querySelectorAll('.lang-en').forEach(el => {
                        el.classList.add('active');
                    });
                    console.warn(`Language code '${languageCode}' not found. Falling back to English.`);
                    return 'en';
                }
                return languageCode;
            }
            
            // Update feedback button text based on current language
            function updateFeedbackButton(languageCode) {
                // Hide all language-specific text
                document.querySelectorAll('.feedback-text').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Show text for the detected language
                const langElement = document.querySelector(`.feedback-text.lang-${languageCode}`);
                if (langElement) {
                    langElement.classList.add('active');
                } else {
                    // Fallback to English if the language code isn't found
                    document.querySelector('.feedback-text.lang-en').classList.add('active');
                }
            }
            
            // Find matching language
            function getRecommendedLanguages(languageCode) {
                const recommendations = [];
                
                // Check for exact match
                const exactMatch = languages.find(lang => lang.code === languageCode);
                if (exactMatch) {
                    recommendations.push(exactMatch);
                }
                
                // Add other languages for reference
                const otherLangs = languages.filter(lang => lang.code !== languageCode);
                recommendations.push(...otherLangs.slice(0, 3)); // Add up to 3 more languages
                
                return recommendations;
            }
            
            // Display language recommendations
            function displayRecommendations(recommendedLangs) {
                const container = document.getElementById('language-recommendation');
                const langsContainer = document.getElementById('recommended-langs');
                
                // Clear previous recommendations
                langsContainer.innerHTML = '';
                
                // Add recommended language links
                recommendedLangs.forEach(lang => {
                    const link = document.createElement('a');
                    link.href = lang.link;
                    link.target = '_blank';
                    link.className = 'recommended-lang';
                    link.textContent = lang.name;
                    
                    langsContainer.appendChild(link);
                });
                
                // Show the container
                container.style.display = 'block';
            }
            
            // Validate language code
            if (!languageCode || typeof languageCode !== 'string') {
                console.error('Please provide a valid language code, e.g., switchLanguage("en")');
                console.log('Available language codes:', languages.map(lang => lang.code).join(', '));
                return;
            }
            
            // Switch to the specified language
            const actualLanguage = showLanguageText(languageCode);
            updateFeedbackButton(actualLanguage);
            
            // Display recommendations including the selected language
            const recommendedLangs = getRecommendedLanguages(actualLanguage);
            displayRecommendations(recommendedLangs);
            
            // Show success message in console
            const langName = languages.find(lang => lang.code === actualLanguage)?.name || 'English';
            console.log(`Switched to ${langName} (${actualLanguage})`);
            console.log('To switch language again, use: switchLanguage("code") where code is one of:', languages.map(lang => lang.code).join(', '));
        };
        
        // Show console message with usage instructions
        console.log('Language Debug Tool');
        console.log('Switch languages using: switchLanguage("code")');
        console.log('Available codes: en, ja, zh-CN, zh-MY, zh-SG, zh-TW');
        console.log('Example: switchLanguage("zh-CN")');
        
    </script>
    <script>
        /**
         * Main application script that works with the LanguageSelector class
         */
        document.addEventListener('DOMContentLoaded', async () => {
            // Language data with names and external links
            const languages = [
                { code: 'en', name: 'English', localName: 'English', link: 'https://chronie-shizutoki.github.io/self-info-en' },
                { code: 'ja', name: '日本語', localName: 'Japanese', link: 'https://self-info-ja.netlify.app/' },
                { code: 'zh-CN', name: '简体中文（中国大陆）', localName: 'Simplified Chinese (China)', link: 'https://chronie-shizutoki-self-info-zh-cn.netlify.app/' },
                { code: 'zh-MY', name: '华文（马来西亚）', localName: 'Chinese (Malaysia)', link: 'https://chronie-shizutoki.github.io/self-info-zh-my/' },
                { code: 'zh-SG', name: '华文（新加坡）', localName: 'Chinese (Singapore)', link: 'https://chronie-shizutoki.github.io/self-info-zh-sg/' },
                { code: 'zh-TW', name: '繁體中文（台灣）', localName: 'Traditional Chinese (Taiwan)', link: 'https://chronie-shizutoki.github.io/self-info-zh-tw/' },
            ];
            
            // Show only the text for the detected language
            function showLanguageText(languageCode) {
                // Hide all language-specific text
                document.querySelectorAll('.language-text p').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Hide all language-specific headings
                document.querySelectorAll('#language-recommendation h3').forEach(el => {
                    el.classList.add('hidden');
                });
                
                // Show text for the detected language
                const langElement = document.querySelector(`.lang-${languageCode}`);
                if (langElement) {
                    document.querySelectorAll(`.lang-${languageCode}`).forEach(el => {
                        el.classList.add('active');
                    });
                } else {
                    // Fallback to English if the language code isn't found
                    document.querySelectorAll('.lang-en').forEach(el => {
                        el.classList.add('active');
                    });
                }
            }
            
            // Check if user is in mainland China
            async function checkIfInMainlandChina() {
                try {
                    // Using a free IP geolocation API
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    // If country is China and region is not Hong Kong or Macau
                    if (data.country_code === 'CN' && data.region !== '91' && data.region !== '92') {
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking location:', error);
                    return false; // Default to not in China if there's an error
                }
            }
            
            // Get user's browser language
            function getUserBrowserLanguage() {
                // Get the browser's language preference
                return navigator.language || navigator.userLanguage; // Return full language code (e.g., 'en-US')
            }
            
            // Find matching language or fallback to Japanese/English
            function getRecommendedLanguages(browserLang) {
                const recommendations = [];
                
                // Special handling for Chinese language codes
                if (browserLang.toLowerCase().startsWith('zh-')) {
                    const zhVariants = ['zh-tw', 'zh-hk', 'zh-mo'];
                    const lowerCaseBrowserLang = browserLang.toLowerCase();
                    
                    // Check if it's a traditional Chinese variant
                    const isTraditionalVariant = zhVariants.some(variant => 
                        lowerCaseBrowserLang === variant || lowerCaseBrowserLang.startsWith(variant + '-')
                    );
                    
                    if (isTraditionalVariant) {
                        // Use Traditional Chinese
                        const zhTWLang = languages.find(lang => lang.code === 'zh-TW');
                        if (zhTWLang) recommendations.push(zhTWLang);
                    } else {
                        // Use Simplified Chinese for all other Chinese variants
                        const zhCNLang = languages.find(lang => lang.code === 'zh-CN');
                        if (zhCNLang) recommendations.push(zhCNLang);
                    }
                    
                    return recommendations;
                }
                
                // Check for exact match
                const exactMatch = languages.find(lang => lang.code === browserLang || lang.code.startsWith(browserLang + '-'));
                if (exactMatch) {
                    recommendations.push(exactMatch);
                }
                
                // If no exact match, add Japanese and English as fallbacks
                if (recommendations.length === 0) {
                    const japanese = languages.find(lang => lang.code === 'ja');
                    const english = languages.find(lang => lang.code === 'en');
                    
                    if (japanese) recommendations.push(japanese);
                    if (english) recommendations.push(english);
                }
                
                return recommendations;
            }
            
            // Display language recommendations
            function displayRecommendations(recommendedLangs) {
                const container = document.getElementById('language-recommendation');
                const langsContainer = document.getElementById('recommended-langs');
                
                // Clear previous recommendations
                langsContainer.innerHTML = '';
                
                // Add recommended language links (max 4 languages)
                const displayLangs = recommendedLangs.slice(0, 4);
                displayLangs.forEach(lang => {
                    const link = document.createElement('a');
                    link.href = lang.link;
                    link.target = '_blank';
                    link.className = 'recommended-lang';
                    link.textContent = lang.name;
                    
                    langsContainer.appendChild(link);
                });
                
                // Show the container
                container.style.display = 'block';
            }
            
            // Main function to handle language recommendation and location check
            async function handleLanguageSelection() {
                const isInMainlandChina = await checkIfInMainlandChina();
                
                if (isInMainlandChina) {
                    // User is in mainland China, show simplified Chinese version
                    const zhCNLang = languages.find(lang => lang.code === 'zh-CN');
                    if (zhCNLang) {
                        // Show message and provide the link
                        const container = document.getElementById('language-recommendation');
                        const langsContainer = document.getElementById('recommended-langs');
                        
                        // Update the heading text
                        document.querySelector('.lang-zh-CN.hidden').textContent = '根据您的位置，我们推荐：';
                        
                        // Show Chinese text
                        showLanguageText('zh-CN');
                        updateFeedbackButton('zh-CN');
                        
                        const link = document.createElement('a');
                        link.href = zhCNLang.link;
                        link.target = '_blank';
                        link.className = 'recommended-lang';
                        link.textContent = zhCNLang.name;
                        
                        langsContainer.appendChild(link);
                        
                        // Show the container
                        container.style.display = 'block';
                    }
                } else {
                    // User is not in mainland China, proceed with normal language detection
                    const browserLang = getUserBrowserLanguage();
                    const recommendedLangs = getRecommendedLanguages(browserLang);
                    
                    // Show text for the most relevant language
                    const primaryLang = recommendedLangs[0]?.code || 'en';
                    showLanguageText(primaryLang);
                    updateFeedbackButton(primaryLang);
                    
                    // Display up to 4 recommended languages
                    displayRecommendations(recommendedLangs);
                }
            }
            
            // Start the language selection process
            try {
                await handleLanguageSelection();
            } catch (error) {
                console.error('Error in language selection:', error);
                // Fallback: show English and Japanese options if there's an error
                const fallbackLangs = [
                    languages.find(lang => lang.code === 'en'),
                    languages.find(lang => lang.code === 'ja')
                ].filter(Boolean);
                
                if (fallbackLangs.length > 0) {
                    // Show English text as fallback
                    showLanguageText('en');
                    updateFeedbackButton('en');
                    displayRecommendations(fallbackLangs);
                }
            }
        });
    </script>
</body>
</html>